name: CodeQL Security Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

permissions:
  contents: read
  security-events: write

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        queries: security-and-quality
        # For more details on CodeQL's query suites, visit https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/about-code-scanning-with-codeql
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{ matrix.language }}"

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install tools
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit requirements-parser
    
    - name: Run safety check
      run: |
        echo "Checking for known security vulnerabilities..."
        safety check --json > safety-report.json || true
        safety check
      continue-on-error: true
    
    - name: Run pip-audit
      run: |
        echo "Checking for known vulnerabilities in dependencies..."
        pip-audit --desc > pip-audit-report.txt || true
      continue-on-error: true
    
    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          safety-report.json
          pip-audit-report.txt

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
      continue-on-error: true
    
    - name: Detect secrets with detect-secrets
      run: |
        pip install detect-secrets
        detect-secrets scan --all-files --force-use-all-plugins > secrets-report.json || true
      continue-on-error: true
    
    - name: Upload secret scan report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: secret-reports
        path: secrets-report.json

  sast-analysis:
    name: SAST Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install SAST tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit pylint semgrep
    
    - name: Run Bandit security check
      run: |
        echo "Running Bandit security checks..."
        bandit -r src -f json -o bandit-report.json || true
        bandit -r src
      continue-on-error: true
    
    - name: Run Pylint
      run: |
        echo "Running Pylint code analysis..."
        pylint src --exit-zero --output-format=json > pylint-report.json || true
      continue-on-error: true
    
    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/python
      continue-on-error: true
    
    - name: Upload SAST reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: sast-reports
        path: |
          bandit-report.json
          pylint-report.json

  container-scanning:
    name: Container Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: job-application-agent:scan
        outputs: type=docker,dest=/tmp/image.tar
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'job-application-agent:scan'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Upload Trivy results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        category: 'trivy'

  compliance-check:
    name: Compliance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Check SBOM (Software Bill of Materials)
      run: |
        pip install cyclonedx-python
        pip install -r requirements.txt
        cyclonedx-py -r -o cyclonedx-bom.xml
      continue-on-error: true
    
    - name: Upload SBOM
      uses: actions/upload-artifact@v3
      with:
        name: compliance-reports
        path: cyclonedx-bom.xml
    
    - name: Check for license compliance
      run: |
        pip install pip-licenses
        pip-licenses --format=json > licenses.json
        pip-licenses
      continue-on-error: true
    
    - name: Upload license report
      uses: actions/upload-artifact@v3
      with:
        name: license-reports
        path: licenses.json

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [analyze, dependency-check, secret-scanning, sast-analysis, container-scanning, compliance-check]
    
    steps:
    - name: Create security report
      run: |
        echo "# Security Analysis Summary" > SECURITY_REPORT.md
        echo "" >> SECURITY_REPORT.md
        echo "## Analysis Results" >> SECURITY_REPORT.md
        echo "" >> SECURITY_REPORT.md
        echo "- CodeQL Analysis: ${{ needs.analyze.result }}" >> SECURITY_REPORT.md
        echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> SECURITY_REPORT.md
        echo "- Secret Scanning: ${{ needs.secret-scanning.result }}" >> SECURITY_REPORT.md
        echo "- SAST Analysis: ${{ needs.sast-analysis.result }}" >> SECURITY_REPORT.md
        echo "- Container Scanning: ${{ needs.container-scanning.result }}" >> SECURITY_REPORT.md
        echo "- Compliance Check: ${{ needs.compliance-check.result }}" >> SECURITY_REPORT.md
        cat SECURITY_REPORT.md
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## üîí Security Analysis Complete\n\nAll security checks have been completed. Check the artifacts for detailed reports.'
          })
    
    - name: Fail if security issues found
      if: contains(needs.*.result, 'failure')
      run: |
        echo "‚ö†Ô∏è Security issues detected!"
        echo "Please review the artifacts and fix any identified issues."
        exit 1
